---
title: "IDS Final Project"
author: "Bilwa Wagh, Gina O'Riordan, Mitchell Speer, Sharif Nijim"
date: "09/17/2018"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# initialize the environment
rm(list=ls()) 
# load the libraries and data
setwd("/Volumes/GoogleDrive/My Drive/MSDS/04.SL/SL.Team.Project") #Sharif
library(tools)
library(tidyverse)
library(ggplot2)
library(lubridate)
#library(mosaic)
library(rpart)
library(rpart.plot)
library(partykit)
#library(NHANES)
library(randomForest)
library(class)
library(tidyverse)
library(reshape2)
library(caret)
library(mlbench)
library(stats)
library(locfit)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(caret, knitr, dplyr, kableExtra, rpart, rpart.plot,
               MASS, tree, ggplot2, randomForest, obliqueRF,partykit)
pacman::p_load(mlbench, caret, knitr, LogicReg, dplyr, rminer, ROCR, pROC)
options(warn=-1)
#library(neuralnet)
```
 
#1 - Download the data
```{r}
absentee <- read.csv("./Absenteeism_at_work.csv", sep = ';')
glimpse(absentee)
```
  
#2 - Basic exploratory data analysis
```{r}
# check for missing data
sum(is.na(absentee))
```
## Explore Reason for Absence
```{r}
# Explore Reason for Absence
table(absentee$Reason.for.absence)
```
  
B- 43 missing values with reason = 0  
  
```{r}
# Explore Reason for Absence
hist(absentee$Reason.for.absence)
```
```{r}
# Explore Month of absence
table(absentee$Month.of.absence)
```
  
B- 43 missing values with month = 0  
  
```{r}
# Explore Reason for Absence
hist(absentee$Month.of.absence)
```
```{r}
# Explore Day of the week
table(absentee$Day.of.the.week)
```
```{r}
# Explore Day of the week
hist(absentee$Day.of.the.week)
```
```{r}
# Explore seasons
table(absentee$Seasons)
```
```{r}
# Explore seasons
hist(absentee$Seasons)
```
```{r}
# Explore Transportation expense
table(absentee$Transportation.expense)
```
```{r}
# Explore Transportation expense
hist(absentee$Transportation.expense)
```
```{r}
# Explore Distance from residence
table(absentee$Distance.from.Residence.to.Work)
```
```{r}
# Explore Distance from residence
hist(absentee$Distance.from.Residence.to.Work)
```
```{r}
# Explore Service time
table(absentee$Service.time)
```
```{r}
# Explore Service time
hist(absentee$Service.time)
```
```{r}
# Explore Age
table(absentee$Age)
```
```{r}
# Explore Reason for Absence
hist(absentee$Age)
```
```{r}
# Explore work load average
table(absentee$Work.load.Average.day)
```
```{r}
# Explore work load average
hist(absentee$Work.load.Average.day)
```
```{r}
# Explore hit target
table(absentee$Hit.target)
```
```{r}
# Explore hit target
hist(absentee$Hit.target)
```
```{r}
# Explore disciplinary failure
table(absentee$Disciplinary.failure)
```
```{r}
# Explore disciplinary failure
hist(absentee$Disciplinary.failure)
```
```{r}
# Explore Education
table(absentee$Education)
```
```{r}
# Explore Education
hist(absentee$Education)
```
```{r}
# Explore number of children
table(absentee$Son)
```
```{r}
# Explore number of children
hist(absentee$Son)
```
```{r}
# Explore social drinker
table(absentee$Social.drinker)
```
```{r}
# Explore social drinker
hist(absentee$Social.drinker)
```
```{r}
# Explore social smoker
table(absentee$Social.smoker)
```
```{r}
# Explore social smoker
hist(absentee$Social.smoker)
```
```{r}
# Explore pet ownership
table(absentee$Pet)
```
```{r}
# Explore pet ownership
hist(absentee$Pet)
```
```{r}
# Explore weight
table(absentee$Weight)
```
```{r}
# Explore weight
hist(absentee$Weight)
```
```{r}
# Explore height
table(absentee$Height)
```
```{r}
# Explore height
hist(absentee$Height)
```
```{r}
# Explore BMI
table(absentee$Body.mass.index)
```
```{r}
# Explore BMI
hist(absentee$Body.mass.index)
```
```{r}
# Explore Absenteeism time in hours
table(absentee$Absenteeism.time.in.hours)
```
```{r}
# Explore Absenteeism time in hours
hist(absentee$Absenteeism.time.in.hours)
```
```{r}
ggplot(absentee, aes(as.factor(Reason.for.absence), Absenteeism.time.in.hours, color = as.factor(Month.of.absence))) + geom_point()
```

```{r}
absentee %>%
  filter(Absenteeism.time.in.hours <= 40) %>%
ggplot(aes( Absenteeism.time.in.hours, Distance.from.Residence.to.Work)) + geom_col()
```




```{r}
ggplot(absentee, aes(as.factor(absentee$Hit.target), Absenteeism.time.in.hours)) + geom_boxplot()
```
```{r}
ggplot(absentee, aes(absentee$Age, absentee$Absenteeism.time.in.hours)) + geom_point()
```

```{r}
ggplot(absentee, aes(absentee$Month.of.absence, absentee$Absenteeism.time.in.hours, fill = as.factor(absentee$Day.of.the.week))) + geom_col()
```

```{r}
# explore sparseness
table(absentee$Disciplinary.failure)
# pretty sparse - get rid of it
```
```{r}
# explore sparseness
table(absentee$Social.smoker)
# pretty sparse - get rid of it
```
```{r}
# create a new dataset without Disciplinary Failure and Social Smoker
absentee.sparse <- absentee %>%
  dplyr::select(-Disciplinary.failure, -Social.smoker)
```

### Run regular trees, boosted trees, bagged trees, random forest, weighted random forest, and balanced random forest
```{r}
# convert Absenteeism.time.in.hours into a factor
absentee.work <- absentee %>%
  mutate(Absenteeism.time.in.hours = as.factor(ifelse(absentee$Absenteeism.time.in.hours < 16, "D","W")))

#50 replications and a 60%-training/40%-test data split to compute the average test error
set.seed(1842)
R = 50 # set the number of replications
# create the error matrix to store values
error_matrix = matrix(0, ncol=6, nrow=R)

# set up train control
fitControl = trainControl(method = "cv",
                          number = 5,
                          returnData = TRUE,
                          returnResamp = "final",
                          summaryFunction = twoClassSummary,
                          classProbs = TRUE)

## RF v Weighted RF v Balanced RF
# set up train control to do CV
tunegrid = expand.grid(.cp=seq(.01:.1,by=.01)) # tune the complexity parameter
tunegrid_bag = expand.grid(.cp=seq(.01:.1,by=.01)) # tune the complexity parameter
# Try boosting
# NB - boosting commented out based on Mattermost post
#tunegrid_boost = expand.grid(mstop = c(100,200,500), maxdepth = 1:2, nu = c(0.1, 0.01, 0.001))


for (r in 1:R) {
  
  # training test split
  id = holdout(absentee.work$Absenteeism.time.in.hours,
               ratio=.6,
               mode='stratified')
  
  absentee.tr = absentee.work[id$tr,]
  absentee.te = absentee.work[id$ts,]
  
  # a. Run regular trees
  tree_mod = rpart(Absenteeism.time.in.hours ~ ., data = absentee.tr)      
  
  # b. run bagged trees
  bag_mod = train(Absenteeism.time.in.hours ~ ., 
                  absentee.tr, 
                  method ='treebag', 
                  trControl = fitControl,
                  metric = "ROC",
                  preProc = c("center", "scale"),
                  nbagg = 7)
  
  # c. Run Random Forest (100 trees)  
  rf_reg = randomForest(Absenteeism.time.in.hours ~ ., 
                        absentee.tr, 
                        ntree = 100,
                        trControl = fitControl,
                        metric = "ROC",
                        tuneGrid = tunegrid)
  
  # d. Run Weighted Random Forest (100 trees)  
  rf.weighted1 = randomForest(Absenteeism.time.in.hours ~ ., 
                              absentee.tr, 
                              ntree = 100,
                              trControl = fitControl,
                              metric = "ROC",
                              classwt=c(.01,1),
                              tuneGrid = tunegrid)
  
  # e. Run Weighted Random Forest (100 trees)  
  rf.weighted2 = randomForest(Absenteeism.time.in.hours ~ ., 
                              absentee.tr, 
                              ntree = 100,
                              trControl = fitControl,
                              metric = "ROC",
                              classwt=c(1,.01),
                              tuneGrid = tunegrid)
  
  
  # f. Run Balanced Random Forest (100 trees)  
  #nmin = sum(absentee.tr$Class=='bad') # minority class is bad
  rf_balanced_under = randomForest(Absenteeism.time.in.hours ~ ., 
                                   absentee.tr, 
                                   ntree = 100,
                                   sample_size = rep(nmin, 2),
                                   trControl = fitControl,
                                   metric = "ROC",
                                   tuneGrid = tunegrid)
  
  # prediction    
### Run regular trees, boosted trees, bagged trees, random forest, weighted random forest, and balanced random forest
  yhat_tree = predict(tree_mod, absentee.te[,-21], type = 'class')
  # NB - boosting commented out based on Mattermost post
  #yhat_boost <- predict(tree_boost, absentee.te[,-21])
  yhat_bag = predict(bag_mod, absentee.te[,-21])
  yhat_rf = predict(rf_reg, absentee.te[,-21])
  yhat_under = predict(rf_balanced_under, absentee.te[,-21])
  yhat_weighted1 = predict(rf.weighted1, absentee.te[,-21])
  yhat_weighted2 = predict(rf.weighted2, absentee.te[,-21])
  
  # store the errors in the matrix
  error_matrix[r,1] = mean(yhat_tree!=absentee.te[,21])
  # NB - boosting commented out based on Mattermost post
  #error_matrix[r,2] = mean(yhat_boost!=absentee.te[,21])
  error_matrix[r,2] = mean(yhat_bag!=absentee.te[,21])
  error_matrix[r,3] = mean(yhat_rf!=absentee.te[,21])
  error_matrix[r,4] = mean(yhat_under!=absentee.te[,21])
  error_matrix[r,5] = mean(yhat_weighted1!=absentee.te[,21])
  error_matrix[r,6] = mean(yhat_weighted2!=absentee.te[,21])
  
  # just a nice statement to tell you when each loop is done
  cat("Finished Rep",r, "\n")
}
```
  
## 2. Generate comparative boxplots showing the test errors (total of 6 boxplots).  
```{r}
# Label the columns
colnames(error_matrix) = c('Trees', 'Bagged-Trees', 'RF', 'Weighted_RF1', 'Weighted_RF2', 'Balanced_RF')
#melt the matrix
error_matrix_melt = melt(as.data.frame(error_matrix))
#rename the columns
colnames(error_matrix_melt) = c('Method','Error')
#boxplot of the errors
ggplot(error_matrix_melt,mapping=aes(x=Method,y=Error))+
            geom_boxplot()
```